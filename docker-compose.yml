version: '3.8'

volumes:
    mongo-db:
        driver: local
    platform-data:
        driver: local
    rabbitmq-data:
        driver: local
    node-red-data:
        driver: local

services:
    mongo:
        image: mongo:4.4.8
        volumes:
            - mongo-db:/data/db
        ports:
            - 27020:27017

    nginx:
        build: ./nginx
        volumes:
            - ./nginx/templates:/etc/nginx/templates
        ports:
            - '8050:80'
        environment:
            - NGINX_HOST=example.com
            - NGINX_PORT=80
        depends_on:
            - platform

    rabbitmq:
        build: ./rabbitmq
        ports:
            - 1883:1883
            - 8883:8883
        volumes:
            - rabbitmq-data:/keys

    node-red:
        build: ./node-red
        environment:
            - PLATFORM_URL=http://platform:8085
        volumes:
            - node-red-data:/node-red/data

    platform:
        image: founek2/iot-platform
        environment:
            - PORT=8085
            - HOME_PAGE=http://example.com:8085
            - DATABASE_URI=mongodb://mongo:27017/IOTPlatform_v3?authSource=admin
            - MQTT_URL=mqtts://rabbitmq
            - MQTT_PORT=8883
            - NODE_ENV=production
            - AGENDA_JOB_TYPES=
        volumes:
            - platform-data:/keys
        depends_on:
            - mongo
